import argparse
import csv
import logging
import psycopg2.errors
import sys

from django.contrib.gis.geos import Point
from django.core.management.base import BaseCommand
from django.db.utils import IntegrityError
from fahrradparken.models import (
    ParkingFacility,
    ParkingFacilityCondition,
    ParkingFacilityOccupancy,
)

logger = logging.getLogger(__name__)


class Command(BaseCommand):
    help = 'Import parking facility dataset from S3 storage'
    fields = [
        'external_id',
        'capacity',
        'stands',
        'covered',
        'two_tier',
        'secured',
        'parking_garage',
        'type',
        'source',
    ]

    def add_arguments(self, parser):
        parser.add_argument(
            'file', type=argparse.FileType('r'), default=sys.stdin, help='A CSV file'
        )
        parser.add_argument(
            '--delimiter',
            type=str,
            default=';',
            help='CSV file delimiter , or ;',
        )
        parser.add_argument(
            '--skiplist',
            type=str,
            default='False',
            help='If the skiplist should be applied (True) or not (False, Default)',
        )

    def import_from_reader(self, reader, options):
        """Import data"""

        skip_list = [
            7,
            8,
            11,
            12,
            19,
            20,
            24,
            27,
            33,
            34,
            36,
            41,
            52,
            54,
            56,
            99,
            71,
            75,
            76,
            97,
            9990101,
            110,
            3072,
            128,
            131,
            9991501,
            9990103,
            138,
            139,
            148,
            161,
            163,
            165,
            9990901,
            176,
            178,
            186,
            187,
            8142,
            193,
            195,
            200,
            220,
            222,
            223,
            224,
            225,
            229,
            245,
            248,
            253,
            9990104,
            742,
            9991503,
            1760,
            276,
            279,
            2289,
            283,
            288,
            290,
            3390,
            8081,
            303,
            306,
            311,
            317,
            319,
            5302,
            324,
            7420,
            326,
            328,
            349,
            350,
            343,
            5963,
            363,
            368,
            370,
            373,
            374,
            379,
            380,
            382,
            393,
            398,
            402,
            405,
            9990902,
            408,
            9991504,
            414,
            415,
            416,
            7419,
            425,
            431,
            434,
            435,
            436,
            439,
            441,
            456,
            458,
            470,
            474,
            503,
            515,
            521,
            524,
            571,
            577,
            581,
            607,
            9990106,
            616,
            625,
            633,
            642,
            661,
            672,
            681,
            682,
            9990107,
            688,
            710,
            8243,
            7444,
            717,
            736,
            743,
            746,
            753,
            9991506,
            9991507,
            773,
            9991508,
            778,
            815,
            818,
            819,
            820,
            823,
            839,
            855,
            9990903,
            9990904,
            857,
            9990905,
            858,
            9990906,
            859,
            860,
            9990907,
            9990908,
            861,
            862,
            863,
            864,
            9990909,
            99909010,
            866,
            867,
            868,
            870,
            99909011,
            99909012,
            880,
            885,
            903,
            912,
            8257,
            929,
            933,
            941,
            944,
            948,
            976,
            980,
            981,
            986,
            990,
            991,
            992,
            994,
            454,
            1005,
            1006,
            1008,
            1009,
            1015,
            1016,
            1017,
            1019,
            5767,
            1036,
            1037,
            1038,
            1055,
            1058,
            1059,
            1060,
            5210,
            1069,
            1072,
            1077,
            4074,
            5503,
            1083,
            1095,
            1099,
            9991509,
            9991510,
            1107,
            1116,
            1121,
            1122,
            1123,
            9991511,
            1152,
            1153,
            1159,
            1172,
            1181,
            1196,
            1200,
            1205,
            1209,
            1215,
            1220,
            1222,
            1227,
            1238,
            1240,
            9991512,
            1255,
            1256,
            1259,
            1265,
            1268,
            1271,
            1272,
            1281,
            1330,
            7626,
            1331,
            1362,
            1391,
            1396,
            1427,
            1430,
            1433,
            1440,
            1442,
            1444,
            1448,
            1449,
            1450,
            1458,
            9990108,
            1474,
            9990109,
            1478,
            1498,
            1507,
            99909013,
            1520,
            1521,
            1531,
            1551,
            1555,
            1558,
            1561,
            1570,
            1577,
            99909014,
            1580,
            1586,
            1600,
            1626,
            1645,
            1650,
            7027,
            1660,
            1673,
            1681,
            1689,
            1720,
            1721,
            1727,
            1728,
            1743,
            1752,
            7618,
            1757,
            1764,
            5827,
            1783,
            1784,
            1791,
            1792,
            1794,
            9990110,
            1795,
            1801,
            1804,
            1825,
            1830,
            1834,
            9990111,
            1838,
            1886,
            1889,
            1903,
            1905,
            1906,
            8245,
            1908,
            99909015,
            1918,
            1919,
            1928,
            1929,
            1934,
            1937,
            1977,
            1980,
            1982,
            1984,
            1993,
            2005,
            2012,
            2024,
            2028,
            99909016,
            2036,
            2039,
            2041,
            2060,
            2061,
            2071,
            2091,
            2098,
            2112,
            2137,
            9990113,
            2164,
            2173,
            2178,
            2180,
            2182,
            2191,
            2192,
            2206,
            2211,
            2215,
            2218,
            2227,
            2228,
            2230,
            2231,
            2240,
            2241,
            8253,
            2243,
            2281,
            2334,
            6180,
            2325,
            9991516,
            7678,
            2341,
            2344,
            2346,
            2378,
            2395,
            2413,
            2415,
            2418,
            2421,
            2422,
            2443,
            2453,
            2455,
            2466,
            2493,
            2498,
            2506,
            2525,
            2529,
            2530,
            2532,
            2541,
            2542,
            2543,
            8194,
            2554,
            2555,
            2559,
            2564,
            99909018,
            2565,
            2568,
            2570,
            2574,
            2576,
            9991517,
            2582,
            2587,
            2594,
            2599,
            2604,
            6515,
            2615,
            2618,
            2625,
            2645,
            2647,
            2653,
            9990114,
            2657,
            2659,
            2663,
            99909019,
            2683,
            2691,
            2732,
            2739,
            2740,
            2742,
            99909020,
            2746,
            2748,
            2758,
            2765,
            2766,
            2769,
            99909021,
            2773,
            2776,
            918,
            2789,
            2795,
            2796,
            2813,
            2816,
            2819,
            2832,
            2833,
            2841,
            2847,
            2856,
            2870,
            2875,
            9991520,
            2888,
            2889,
            2901,
            2904,
            2911,
            2915,
            2925,
            2834,
            2933,
            2938,
            2951,
            7250,
            2953,
            2962,
            2984,
            8325,
            2993,
            2994,
            3001,
            3002,
            3010,
            3014,
            3016,
            8353,
            3036,
            9990115,
            3053,
            3054,
            9990116,
            3071,
            3078,
            3086,
            9991521,
            3116,
            3118,
            3128,
            3130,
            3132,
            3138,
            3142,
            3151,
            3153,
            3155,
            3156,
            3162,
            3172,
            3174,
            9991523,
            9991524,
            7252,
            7277,
            4245,
            3182,
            3185,
            8074,
            3199,
            3204,
            7550,
            3205,
            3224,
            3242,
            3248,
            3253,
            3235,
            3269,
            99909022,
            99909023,
            7480,
            3304,
            3308,
            3313,
            3343,
            3382,
            3407,
            3410,
            3419,
            3427,
            7257,
            3437,
            3443,
            4861,
            3465,
            99909024,
            7490,
            3489,
            9990117,
            3510,
            3513,
            3514,
            3522,
            3549,
            3560,
            3565,
            3568,
            3569,
            3580,
            3581,
            3582,
            3587,
            3592,
            3609,
            3617,
            3655,
            3661,
            3664,
            8085,
            3666,
            3669,
            3684,
            3700,
            3709,
            3728,
            3727,
            3729,
            3736,
            3740,
            3741,
            3743,
            3757,
            3760,
            3764,
            3767,
            3779,
            3796,
            3799,
            3802,
            3805,
            3806,
            3808,
            3807,
            8300,
            3810,
            6305,
            3827,
            3835,
            3841,
            3845,
            3848,
            3854,
            3855,
            3858,
            3863,
            8024,
            3881,
            3891,
            3894,
            3896,
            3897,
            3914,
            3946,
            3953,
            3973,
            9990119,
            3976,
            3977,
            3980,
            3986,
            3996,
            4006,
            4014,
            4041,
            4044,
            4049,
            4051,
            4061,
            4064,
            5616,
            4073,
            7501,
            9990121,
            4102,
            4108,
            4109,
            4117,
            4134,
            4142,
            4149,
            9991529,
            4172,
            9990122,
            4190,
            4201,
            4203,
            4204,
            4211,
            4214,
            4227,
            4228,
            4231,
            4234,
            8154,
            4240,
            4243,
            4246,
            4247,
            4248,
            4249,
            4250,
            4253,
            4254,
            4255,
            4257,
            4258,
            4260,
            4261,
            4262,
            4264,
            4266,
            4267,
            4270,
            4273,
            4279,
            4284,
            4290,
            4303,
            4304,
            4305,
            4306,
            4337,
            4344,
            4348,
            4359,
            4360,
            4362,
            4367,
            4382,
            99909025,
            99909026,
            4383,
            4384,
            4389,
            4390,
            4397,
            4411,
            4416,
            4420,
            8063,
            9991531,
            9990125,
            4437,
            4443,
            8195,
            4452,
            9990126,
            4472,
            4494,
            4496,
            4507,
            4517,
            4548,
            4567,
            4571,
            4573,
            9991532,
            4575,
            4579,
            99909027,
            99909028,
            4580,
            4581,
            4586,
            4587,
            4588,
            4593,
            4600,
            4601,
            4603,
            4611,
            9991533,
            4618,
            4620,
            4621,
            4632,
            4635,
            4642,
            4643,
            4645,
            4666,
            4679,
            4688,
            4690,
            4691,
            4693,
            4709,
            4726,
            4727,
            99909029,
            99909030,
            4763,
            4764,
            4765,
            8265,
            4766,
            4777,
            4781,
            4786,
            4787,
            99909031,
            4793,
            4795,
            4801,
            4802,
            4826,
            4828,
            4829,
            4830,
            4834,
            4836,
            4844,
            4851,
            4855,
            4857,
            4863,
            4868,
            4876,
            4879,
            4883,
            4886,
            4888,
            4889,
            4891,
            4896,
            4897,
            4901,
            8193,
            4905,
            4907,
            4912,
            4913,
            4925,
            4927,
            4929,
            4934,
            4935,
            4952,
            4963,
            4981,
            4984,
            4994,
            5005,
            5012,
            5022,
            5027,
            5029,
            5042,
            7619,
            5050,
            5052,
            5051,
            5054,
            5060,
            5063,
            5066,
            99909032,
            5081,
            5082,
            5091,
            5101,
            5104,
            9990128,
            5653,
            5114,
            5115,
            5126,
            5131,
            5139,
            5142,
            5151,
            5156,
            5158,
            5169,
            5178,
            5189,
            5192,
            5200,
            5201,
            5205,
            5235,
            5240,
            7524,
            5270,
            5275,
            5279,
            7525,
            5289,
            5293,
            5306,
            5307,
            5318,
            5321,
            5323,
            5329,
            5348,
            9990129,
            5352,
            5363,
            5380,
            5389,
            5393,
            5396,
            5401,
            5417,
            5426,
            5427,
            5438,
            99909033,
            5439,
            5447,
            5470,
            5476,
            5495,
            5497,
            5502,
            5504,
            5510,
            5519,
            5532,
            9990131,
            5552,
            5565,
            5573,
            5597,
            7425,
            5609,
            5622,
            5623,
            8010,
            5629,
            5630,
            9990132,
            5644,
            5645,
            7534,
            5659,
            5661,
            5662,
            5675,
            2646,
            7282,
            5693,
            5697,
            5702,
            5715,
            5716,
            5723,
            5726,
            5742,
            5746,
            5751,
            5768,
            5775,
            5776,
            5784,
            7743,
            5788,
            5793,
            2427,
            5798,
            5811,
            99909034,
            5831,
            5835,
            5846,
            5860,
            5892,
            8011,
            5907,
            5912,
            5913,
            9990133,
            5921,
            5935,
            5944,
            5950,
            5954,
            5958,
            5970,
            4750,
            5975,
            9990134,
            5981,
            5995,
            9990135,
            6008,
            6010,
            6029,
            6032,
            6052,
            6058,
            6059,
            6067,
            6094,
            6096,
            6098,
            6110,
            6122,
            6128,
            9990136,
            6138,
            6146,
            6147,
            6148,
            6150,
            6157,
            9990137,
            4379,
            6167,
            6169,
            6186,
            6189,
            6190,
            6197,
            6203,
            6209,
            6218,
            6222,
            6223,
            6225,
            6230,
            6231,
            6233,
            9990138,
            6244,
            6252,
            6263,
            6277,
            9990139,
            6287,
            6289,
            6295,
            6308,
            6310,
            6311,
            6330,
            6341,
            6346,
            6350,
            6352,
            6359,
            6363,
            6380,
            6393,
            6394,
            6395,
            6398,
            6401,
            6404,
            6406,
            6408,
            6421,
            6426,
            6436,
            6444,
            6455,
            9991541,
            6465,
            6473,
            6474,
            7870,
            6491,
            6499,
            6508,
            6510,
            6519,
            6520,
            6547,
            6554,
            6557,
            6558,
            6575,
            6576,
            99909035,
            9990140,
            6591,
            6598,
            9990141,
            6604,
            6610,
            6611,
            6616,
            9990142,
            9990143,
            6635,
            6650,
            99909036,
            6658,
            6668,
            7560,
            6681,
            6691,
            6692,
            6704,
            8065,
            6705,
            6712,
            6713,
            6714,
            4719,
            6719,
            6741,
            6743,
            6752,
            6761,
            6766,
            6772,
            6775,
            7961,
            6786,
            6794,
            6795,
            6798,
            6799,
            6805,
            6809,
            6820,
            6825,
            6836,
            9990144,
            6842,
            6858,
            6876,
            6895,
            6896,
            6904,
            9990145,
            6910,
            6912,
            6945,
            6949,
            7568,
            6957,
            7884,
            6981,
            6983,
            6998,
            7005,
            7010,
            7030,
            7040,
            7045,
            7072,
            7073,
        ]

        for row in reader:
            condition = row.get('condition')
            occupancy = row.get('occupancy')
            coordinates = row.get('location', '').split(', ')

            if len(coordinates) != 2:
                logger.warning(
                    f"Skipped importing parking facility {row['external_id']} due to malformed or missing coordinates"
                )
                continue

            longitude = float(coordinates[1].strip().replace(',', '.'))
            latitude = float(coordinates[0].strip().replace(',', '.'))
            kwargs = {k: row[k] if row[k] != '' else None for k in self.fields}
            kwargs['location'] = Point(longitude, latitude)
            kwargs['station_id'] = kwargs['external_id'].split('.')[0]

            if str(options['skiplist']).lower() == 'true':
                if int(kwargs['station_id']) in skip_list:
                    logger.warning(
                        f"Skipped importing parking facility {kwargs['external_id']} because station {kwargs['station_id']} is part of the skiplist"
                    )
                    continue

            try:
                created = ParkingFacility.objects.create(**kwargs)
                if condition:
                    ParkingFacilityCondition.objects.create(
                        parking_facility=created, value=condition
                    )
                if occupancy:
                    ParkingFacilityOccupancy.objects.create(
                        parking_facility=created, value=occupancy
                    )
            except IntegrityError as e:
                if type(e.__cause__) == psycopg2.errors.ForeignKeyViolation:
                    logger.warning(
                        'Skipped importing parking facility for missing station '
                        f"{kwargs['station_id']}"
                    )
                elif type(e.__cause__) == psycopg2.errors.UniqueViolation:
                    logger.warning(
                        'Skipped importing duplicate parking facility '
                        f"{row['external_id']}"
                    )
                else:
                    raise

    def handle(self, *args, **options):
        reader = csv.DictReader(options['file'], delimiter=options['delimiter'])
        logger.warn(f"CSV delimiter is {options['delimiter']}")
        logger.warn(f"Respect skiplist is {options['skiplist']}")
        self.import_from_reader(reader, options)
